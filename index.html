<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Environmental Sensor</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #sensorData { font-size: 1.2em; margin: 20px 0; }
        button { font-size: 1em; padding: 10px 20px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ESP32 Environmental Sensor</h1>
    <button id="connectButton">Connect to ESP32</button>
    <div id="sensorData">
        <p>Temperature: -- °C</p>
        <p>Pressure: -- hPa</p>
        <p>Humidity: -- %</p>
        <p>Gas: -- Ohms</p>
        <p>Light: -- lux</p>
        <p>Acceleration: X: -- Y: -- Z: --</p>
        <p>Gyroscope: X: -- Y: -- Z: --</p>
    </div>

    <script>
        const SERVICE_UUID = "181a";  // Environmental Sensing Service UUID
        const CHAR_TEMP_UUID = "2a6e";
        const CHAR_PRESSURE_UUID = "2a6d";
        const CHAR_HUMIDITY_UUID = "2a6f";
        const CHAR_GAS_UUID = "2a70";
        const CHAR_LIGHT_UUID = "2a77";
        const CHAR_ACCEL_UUID = "2a5a";
        const CHAR_GYRO_UUID = "2a5b";

        let device;

        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                console.log("Requesting Bluetooth Device...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });

                console.log("Connecting to GATT Server...");
                const server = await device.gatt.connect();

                console.log("Getting Environmental Sensing Service...");
                const service = await server.getPrimaryService(SERVICE_UUID);

                // Get characteristics
                const tempChar = await service.getCharacteristic(CHAR_TEMP_UUID);
                const pressureChar = await service.getCharacteristic(CHAR_PRESSURE_UUID);
                const humidityChar = await service.getCharacteristic(CHAR_HUMIDITY_UUID);
                const gasChar = await service.getCharacteristic(CHAR_GAS_UUID);
                const lightChar = await service.getCharacteristic(CHAR_LIGHT_UUID);
                const accelChar = await service.getCharacteristic(CHAR_ACCEL_UUID);
                const gyroChar = await service.getCharacteristic(CHAR_GYRO_UUID);

                // Add event listeners for characteristic value changes
                tempChar.addEventListener('characteristicvaluechanged', handleTempChange);
                pressureChar.addEventListener('characteristicvaluechanged', handlePressureChange);
                humidityChar.addEventListener('characteristicvaluechanged', handleHumidityChange);
                gasChar.addEventListener('characteristicvaluechanged', handleGasChange);
                lightChar.addEventListener('characteristicvaluechanged', handleLightChange);
                accelChar.addEventListener('characteristicvaluechanged', handleAccelChange);
                gyroChar.addEventListener('characteristicvaluechanged', handleGyroChange);

                // Start notifications for all characteristics
                await tempChar.startNotifications();
                await pressureChar.startNotifications();
                await humidityChar.startNotifications();
                await gasChar.startNotifications();
                await lightChar.startNotifications();
                await accelChar.startNotifications();
                await gyroChar.startNotifications();

                console.log('Connected and notifications started');
                document.getElementById('connectButton').textContent = 'Connected';
            } catch (error) {
                console.error('Connection failed:', error);
            }
        });

        // Handle characteristic changes and update UI
        function handleTempChange(event) {
            const value = new DataView(event.target.value.buffer);
            const temp = value.getUint16(0, true) / 100; // Correct byte order and scaling
            updateSensorData('Temperature', `${temp.toFixed(2)} °C`);
        }

        function handlePressureChange(event) {
            const value = new DataView(event.target.value.buffer);
            const pressure = value.getUint32(0, true) / 100; // Correct byte order and scaling
            updateSensorData('Pressure', `${pressure.toFixed(2)} hPa`);
        }

        function handleHumidityChange(event) {
            const value = new DataView(event.target.value.buffer);
            const humidity = value.getUint16(0, true) / 100; // Correct byte order and scaling
            updateSensorData('Humidity', `${humidity.toFixed(2)} %`);
        }

        function handleGasChange(event) {
            const value = new DataView(event.target.value.buffer);
            const gas = value.getUint32(0, true); // Correct byte order
            updateSensorData('Gas', `${gas} Ohms`);
        }

        function handleLightChange(event) {
            const value = new DataView(event.target.value.buffer);
            const light = value.getUint16(0, true); // Correct byte order
            updateSensorData('Light', `${light} lux`);
        }

        function handleAccelChange(event) {
            const value = new DataView(event.target.value.buffer);
            const accelX = value.getInt16(0, true);
            const accelY = value.getInt16(2, true);
            const accelZ = value.getInt16(4, true);
            updateSensorData('Acceleration', `X: ${accelX}, Y: ${accelY}, Z: ${accelZ}`);
        }

        function handleGyroChange(event) {
            const value = new DataView(event.target.value.buffer);
            const gyroX = value.getInt16(0, true);
            const gyroY = value.getInt16(2, true);
            const gyroZ = value.getInt16(4, true);
            updateSensorData('Gyroscope', `X: ${gyroX}, Y: ${gyroY}, Z: ${gyroZ}`);
        }

        // Update the sensor data in the UI
        function updateSensorData(sensorType, value) {
            const sensorDataDiv = document.getElementById('sensorData');
            const paragraphs = sensorDataDiv.getElementsByTagName('p');
            for (let p of paragraphs) {
                if (p.textContent.startsWith(sensorType)) {
                    p.textContent = `${sensorType}: ${value}`;
                    break;
                }
            }
        }
    </script>
</body>
</html>
