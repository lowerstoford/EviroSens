<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Sensor Hub</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #sensorData { font-size: 1.2em; margin: 20px 0; text-align: left; max-width: 600px; margin: 0 auto; }
        button { font-size: 1em; padding: 10px 20px; margin: 20px; }
    </style>
</head>
<body>
    <h1>ESP32 Sensor Hub</h1>
    <button id="connectButton">Connect to ESP32</button>
    <div id="sensorData">
        <p>Temperature: -- °C</p>
        <p>Pressure: -- hPa</p>
        <p>Humidity: -- %</p>
        <p>Gas: -- Ohms</p>
        <p>Light: -- lux</p>
        <p>Acceleration: X: -- , Y: -- , Z: -- m/s²</p>
    </div>

    <script>
        const SERVICE_UUID = "181a";
        const CHAR_TEMP_UUID = "2a6e";
        const CHAR_PRESSURE_UUID = "2a6d";
        const CHAR_HUMIDITY_UUID = "2a6f";
        const CHAR_GAS_UUID = "2a70";
        const CHAR_LIGHT_UUID = "2a77";
        const CHAR_ACCEL_UUID = "2713";
        let device;

        document.getElementById('connectButton').addEventListener('click', connectToDevice);

        async function connectToDevice() {
            try {
                console.log("Requesting Bluetooth Device...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });

                console.log("Connecting to GATT Server...");
                const server = await device.gatt.connect();

                console.log("Getting Environmental Sensing Service...");
                const service = await server.getPrimaryService(SERVICE_UUID);

                console.log("Getting Characteristics...");
                const tempChar = await service.getCharacteristic(CHAR_TEMP_UUID);
                const pressureChar = await service.getCharacteristic(CHAR_PRESSURE_UUID);
                const humidityChar = await service.getCharacteristic(CHAR_HUMIDITY_UUID);
                const gasChar = await service.getCharacteristic(CHAR_GAS_UUID);
                const lightChar = await service.getCharacteristic(CHAR_LIGHT_UUID);
                const accelChar = await service.getCharacteristic(CHAR_ACCEL_UUID);

                tempChar.addEventListener('characteristicvaluechanged', handleTempChange);
                pressureChar.addEventListener('characteristicvaluechanged', handlePressureChange);
                humidityChar.addEventListener('characteristicvaluechanged', handleHumidityChange);
                gasChar.addEventListener('characteristicvaluechanged', handleGasChange);
                lightChar.addEventListener('characteristicvaluechanged', handleLightChange);
                accelChar.addEventListener('characteristicvaluechanged', handleAccelChange);

                console.log("Starting notifications...");
                await tempChar.startNotifications();
                await pressureChar.startNotifications();
                await humidityChar.startNotifications();
                await gasChar.startNotifications();
                await lightChar.startNotifications();
                await accelChar.startNotifications();

                console.log('Connected to ESP32');
                document.getElementById('connectButton').textContent = 'Connected';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function handleTempChange(event) {
            const temp = event.target.value.getUint16(0, true) / 100;
            updateSensorData('Temperature', `${temp.toFixed(2)} °C`);
        }

        function handlePressureChange(event) {
            const pressure = event.target.value.getUint32(0, true) / 100;
            updateSensorData('Pressure', `${pressure.toFixed(2)} hPa`);
        }

        function handleHumidityChange(event) {
            const humidity = event.target.value.getUint16(0, true) / 100;
            updateSensorData('Humidity', `${humidity.toFixed(2)} %`);
        }

        function handleGasChange(event) {
            const gas = event.target.value.getUint32(0, true);
            updateSensorData('Gas', `${gas} Ohms`);
        }

        function handleLightChange(event) {
            const light = event.target.value.getUint16(0, true) / 100;
            updateSensorData('Light', `${light.toFixed(2)} lux`);
        }

        function handleAccelChange(event) {
            const dataView = event.target.value;
            const accX = dataView.getFloat32(0, true);
            const accY = dataView.getFloat32(4, true);
            const accZ = dataView.getFloat32(8, true);
            updateSensorData('Acceleration', `X: ${accX.toFixed(2)}, Y: ${accY.toFixed(2)}, Z: ${accZ.toFixed(2)} m/s²`);
        }

        function updateSensorData(sensorType, value) {
            const sensorDataDiv = document.getElementById('sensorData');
            const paragraphs = sensorDataDiv.getElementsByTagName('p');
            for (let p of paragraphs) {
                if (p.textContent.startsWith(sensorType)) {
                    p.textContent = `${sensorType}: ${value}`;
                    break;
                }
            }
        }
    </script>
</body>
</html>
