<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BME680 and BH1750 BLE Sensor</title>
</head>
<body>
    <h1>ESP32 BME680 and BH1750 BLE Sensor</h1>
    <button onclick="connect()">Connect to ESP32</button>
    <div id="sensorData">
        <p>Temperature: <span id="temperature">-- °C</span></p>
        <p>Pressure: <span id="pressure">-- hPa</span></p>
        <p>Humidity: <span id="humidity">-- %</span></p>
        <p>Gas: <span id="gas">-- Ohms</span></p>
        <p>Light: <span id="light">-- lux</span></p>
    </div>
    <script>
        const serviceUuid = '181a';
        const tempCharacteristic = '2a6e';
        const pressureCharacteristic = '2a6d';
        const humidityCharacteristic = '2a6f';
        const gasCharacteristic = '2a70';
        const lightCharacteristic = '2a77';

        let device, server, service;

        async function connect() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [serviceUuid] }]
                });
                server = await device.gatt.connect();
                service = await server.getPrimaryService(serviceUuid);
                
                const characteristics = [
                    tempCharacteristic,
                    pressureCharacteristic,
                    humidityCharacteristic,
                    gasCharacteristic,
                    lightCharacteristic
                ];

                for (const uuid of characteristics) {
                    const characteristic = await service.getCharacteristic(uuid);
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', handleCharacteristic);
                }

                console.log('Connected to ESP32');
            } catch (error) {
                console.error('Connection failed:', error);
            }
        }

        function handleCharacteristic(event) {
            const characteristic = event.target;
            const value = characteristic.value;

            if (characteristic.uuid === tempCharacteristic) {
                const temp = value.getUint16(0, true) / 100;
                document.getElementById('temperature').textContent = temp.toFixed(2) + ' °C';
            } else if (characteristic.uuid === pressureCharacteristic) {
                const pressure = value.getUint32(0, true) / 100;
                document.getElementById('pressure').textContent = pressure.toFixed(2) + ' hPa';
            } else if (characteristic.uuid === humidityCharacteristic) {
                const humidity = value.getUint16(0, true) / 100;
                document.getElementById('humidity').textContent = humidity.toFixed(2) + ' %';
            } else if (characteristic.uuid === gasCharacteristic) {
                const gas = value.getUint32(0, true);
                document.getElementById('gas').textContent = gas + ' Ohms';
            } else if (characteristic.uuid === lightCharacteristic) {
                const light = value.getUint32(0, true) / 100;
                document.getElementById('light').textContent = light.toFixed(2) + ' lux';
            }
        }
    </script>
</body>
</html>
